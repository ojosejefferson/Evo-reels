<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard EVO Reels Analytics</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN (Mantido para gráficos futuros, mas o gráfico principal foi removido) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Ícone Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Configuração do Tailwind para o layout SaaS e cores customizadas -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Cores de fundo e superfície
                        'primary-dark': '#0f172a',
                        'secondary-dark': '#1e293b',
                        'primary-light': '#f8fafc',
                        'secondary-light': '#ffffff',
                        'highlight-bg': '#4f46e5', // Indigo-600 para destaque
                        'highlight-text': '#ffffff',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Estilo para a porcentagem de crescimento */
        .trend-up { color: #10b981; } /* Emerald-500 */
        .trend-down { color: #ef4444; } /* Red-500 */
        /* Estilos específicos para o modo escuro no indicador de tendência (quando não em destaque) */
        .dark .trend-up { color: #34d399; }
        .dark .trend-down { color: #f87171; }
        
        /* Estilos base para o card compacto/secundário */
        .compact-card {
            height: 100%;
        }
        
        /* NOVO: Estilo do card MEDIUM em destaque (Hardcoded para Indigo-600/Branco) */
        .medium-highlight-card {
             background-color: #4f46e5; /* Indigo-600 */
             color: #ffffff; /* White (Texto Principal) */
             box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        /* Ajuste do fundo no modo escuro para contraste */
        .dark .medium-highlight-card {
             background-color: #3730a3; /* Indigo-700 mais escuro no modo escuro */
             box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
             color: #ffffff;
        }
        /* Ajuste dos elementos internos para serem brancos */
        .medium-highlight-card .icon-bg {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .medium-highlight-card .text-title {
            color: rgba(255, 255, 255, 0.8); /* Cor do título (Light Gray) */
        }
        /* Cores de tendência devem ser claras para o fundo escuro do card */
        .medium-highlight-card .trend-up { color: #34d399; } 
        .medium-highlight-card .trend-down { color: #f87171; } 
    </style>
</head>
<body class="bg-primary-light dark:bg-primary-dark text-gray-800 dark:text-gray-100 min-h-screen transition-colors duration-300">

    <!-- CONTEÚDO PRINCIPAL (FULL WIDTH) -->
    <main id="mainContent" class="flex-1 p-4 md:p-8">
        
        <!-- HEADER, TÍTULO E DARK MODE TOGGLE + FILTRO -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 pb-4 border-b border-gray-200 dark:border-gray-700">
            
            <!-- TÍTULO PRINCIPAL (Esquerda) -->
            <h1 class="text-3xl font-extrabold text-indigo-600 dark:text-indigo-400 mb-4 md:mb-0">
                Dashboard EVO Reels Analytics
            </h1>
            
            <!-- CONTROLES (Direita: Filtro + Datas Customizadas + Dark Mode Toggle) -->
            <div class="flex flex-wrap items-center gap-4 justify-end">
                
                <!-- GRUPO DE FILTRO (SELECT + DATAS CUSTOMIZADAS) -->
                <div id="filterControlGroup" class="flex items-center gap-2 flex-wrap justify-end">
                    
                    <!-- Período Selecionado Label (Hidden em telas pequenas) -->
                    <h3 class="text-base font-semibold text-gray-600 dark:text-gray-400 hidden sm:block whitespace-nowrap">Período: 
                        <span id="currentPeriod" class="text-indigo-500 font-medium">(Últimos 7 dias)</span>
                    </h3>
                    
                    <!-- SELECT de Filtro -->
                    <select id="timeFilter" onchange="applyFilter(this.value)" class="p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-300">
                        <option value="last_7_days">Últimos 7 dias</option>
                        <option value="last_30_days">Últimos 30 dias</option>
                        <option value="this_month">Este Mês</option>
                        <option value="last_month">Mês Passado</option>
                        <option value="last_6_months">Últimos 6 Meses</option>
                        <option value="last_12_months">Últimos 12 Meses</option>
                        <option value="custom">Personalizado</option>
                    </select>

                    <!-- DATAS CUSTOMIZADAS (Aparece quando 'custom' é selecionado) -->
                    <div id="customDateRange" class="flex gap-2 hidden items-center">
                        <input type="date" placeholder="Início" class="p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-sm transition-colors duration-300 w-32">
                        <input type="date" placeholder="Fim" class="p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-sm transition-colors duration-300 w-32">
                        <button class="bg-indigo-500 text-white p-2 rounded-lg text-sm hover:bg-indigo-600 transition duration-150">Aplicar</button>
                    </div>
                </div>
                
                <!-- Botão Dark Mode -->
                <button id="themeToggle" class="p-2 rounded-full bg-secondary-light dark:bg-secondary-dark shadow-md hover:ring-2 ring-indigo-500 transition-all duration-300" aria-label="Alternar Modo Escuro/Claro">
                    <i data-lucide="sun" id="sunIcon" class="w-6 h-6 text-yellow-500 hidden"></i>
                    <i data-lucide="moon" id="moonIcon" class="w-6 h-6 text-gray-300"></i>
                </button>
            </div>
        </header>

        <!-- Filtro Customizado (OLD LOCATION, agora vazio) -->
        <!-- O conteúdo foi movido para o cabeçalho acima. -->


        <!-- SEÇÃO 2: MÉTRICAS HIERÁRQUICAS (3 COLUNAS - MEDIUM/SMALL CARDS) -->
        <section class="mb-10">
            <div id="secondaryMetricsContainer" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Blocos de categorias serão injetados aqui -->
            </div>
        </section>


        <!-- SEÇÃO DE MÉTRICAS POR PRODUTO/VÍDEO (TABELA) -->
        <section>
            <h2 class="text-2xl font-bold mb-4">Performance Detalhada por Produto</h2>
            <div class="bg-secondary-light dark:bg-secondary-dark rounded-xl shadow-lg overflow-x-auto border border-gray-100 dark:border-gray-800 transition-colors duration-300">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Produto / Reel</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total Views</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Likes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Shares</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">CTR</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Compras Iniciadas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Vendas Finalizadas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Valor Total Gerado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ticket Médio</th>
                        </tr>
                    </thead>
                    <tbody id="productListBody" class="divide-y divide-gray-200 dark:divide-gray-800">
                        <!-- Linhas de produtos serão injetadas aqui -->
                    </tbody>
                </table>
            </div>
        </section>

    </main>
    

    <script>
        // Inicializa o Lucide Icons
        lucide.createIcons();

        // ------------------------------------------
        // LÓGICA DO MODO CLARO/ESCURO
        // ------------------------------------------

        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const htmlElement = document.documentElement;

        function updateIcons(isDark) {
            if (isDark) {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        }

        const isDarkPreferred = localStorage.getItem('theme') === 'dark' || 
                                (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);

        if (isDarkPreferred) {
            htmlElement.classList.add('dark');
            updateIcons(true);
        } else {
            htmlElement.classList.remove('dark');
            updateIcons(false);
        }

        themeToggle.addEventListener('click', () => {
            if (htmlElement.classList.contains('dark')) {
                htmlElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                updateIcons(false);
            } else {
                htmlElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                updateIcons(true);
            }
            applyFilter(document.getElementById('timeFilter').value); 
        });


        // ------------------------------------------
        // DADOS MOCKADOS (SIMULAÇÃO DO BANCO DE DADOS)
        // ------------------------------------------

        const mockGlobalMetrics = {
            last_7_days: {
                totalViews: 4500, totalLikes: 320, totalShares: 85, totalCTR: 8.5, purchasesStarted: 150, salesFinalized: 45, totalValue: 12500.50, averageTicket: 277.79, completion: 78.2,
                trends: {
                    totalViews: { change: 15.2, direction: 1 }, 
                    completion: { change: -3.1, direction: -1 }, 
                    totalCTR: { change: 5.5, direction: 1 },
                    salesFinalized: { change: 25.0, direction: 1 },
                    totalValue: { change: 25.0, direction: 1 },
                    averageTicket: { change: -1.2, direction: -1 },
                    totalLikes: { change: 10.0, direction: 1 },
                    totalShares: { change: -5.0, direction: -1 },
                    purchasesStarted: { change: 30.0, direction: 1 }
                }
            },
            last_30_days: {
                totalViews: 18000, totalLikes: 1400, totalShares: 350, totalCTR: 7.2, purchasesStarted: 550, salesFinalized: 175, totalValue: 48000.00, averageTicket: 274.28, completion: 75.5,
                trends: {
                    totalViews: { change: 5.0, direction: 1 },
                    completion: { change: 0.5, direction: 1 },
                    totalCTR: { change: -2.0, direction: -1 },
                    salesFinalized: { change: 10.0, direction: 1 },
                    totalValue: { change: 8.0, direction: 1 },
                    averageTicket: { change: -0.5, direction: -1 },
                    totalLikes: { change: 12.0, direction: 1 },
                    totalShares: { change: 1.0, direction: 1 },
                    purchasesStarted: { change: 7.0, direction: 1 }
                }
            },
            // ... (Outros períodos mockados para demonstração)
            this_month: { totalViews: 9800, totalLikes: 750, totalShares: 180, totalCTR: 7.8, purchasesStarted: 300, salesFinalized: 95, totalValue: 26000.75, averageTicket: 273.69, completion: 77.1, trends: { totalViews: { change: 1.0, direction: 1 }, completion: { change: 2.1, direction: 1 }, totalCTR: { change: 3.0, direction: 1 }, salesFinalized: { change: 5.0, direction: 1 }, totalValue: { change: 4.0, direction: 1 }, averageTicket: { change: 0.5, direction: 1 }, totalLikes: { change: 2.0, direction: 1 }, totalShares: { change: 1.5, direction: 1 }, purchasesStarted: { change: 3.0, direction: 1 } } },
            last_month: { totalViews: 12000, totalLikes: 950, totalShares: 250, totalCTR: 6.9, purchasesStarted: 420, salesFinalized: 140, totalValue: 39000.00, averageTicket: 278.57, completion: 74.9, trends: { totalViews: { change: -2.0, direction: -1 }, completion: { change: -1.1, direction: -1 }, totalCTR: { change: -1.0, direction: -1 }, salesFinalized: { change: -10.0, direction: -1 }, totalValue: { change: -5.0, direction: -1 }, averageTicket: { change: 1.5, direction: 1 }, totalLikes: { change: -3.0, direction: -1 }, totalShares: { change: -2.0, direction: -1 }, purchasesStarted: { change: -8.0, direction: -1 } } },
            last_6_months: { totalViews: 75000, totalLikes: 6000, totalShares: 1500, totalCTR: 7.5, purchasesStarted: 2700, salesFinalized: 850, totalValue: 240000.00, averageTicket: 282.35, completion: 76.8, trends: { totalViews: { change: 10.0, direction: 1 }, completion: { change: 3.0, direction: 1 }, totalCTR: { change: 5.0, direction: 1 }, salesFinalized: { change: 15.0, direction: 1 }, totalValue: { change: 12.0, direction: 1 }, averageTicket: { change: 2.0, direction: 1 }, totalLikes: { change: 8.0, direction: 1 }, totalShares: { change: 10.0, direction: 1 }, purchasesStarted: { change: 11.0, direction: 1 } } },
            last_12_months: { totalViews: 150000, totalLikes: 12000, totalShares: 3000, totalCTR: 7.0, purchasesStarted: 5000, salesFinalized: 1500, totalValue: 450000.00, averageTicket: 300.00, completion: 77.0, trends: { totalViews: { change: 20.0, direction: 1 }, completion: { change: 5.0, direction: 1 }, totalCTR: { change: 10.0, direction: 1 }, salesFinalized: { change: 30.0, direction: 1 }, totalValue: { change: 25.0, direction: 1 }, averageTicket: { change: 5.0, direction: 1 }, totalLikes: { change: 15.0, direction: 1 }, totalShares: { change: 20.0, direction: 1 }, purchasesStarted: { change: 22.0, direction: 1 } } },
            custom: { totalViews: 2500, totalLikes: 150, totalShares: 50, totalCTR: 9.1, purchasesStarted: 80, salesFinalized: 30, totalValue: 10000.00, averageTicket: 333.33, completion: 80.5, trends: { totalViews: { change: 0, direction: 0 }, completion: { change: 0, direction: 0 }, totalCTR: { change: 0, direction: 0 }, salesFinalized: { change: 0, direction: 0 }, totalValue: { change: 0, direction: 0 }, averageTicket: { change: 0, direction: 0 }, totalLikes: { change: 0, direction: 0 }, totalShares: { change: 0, direction: 0 }, purchasesStarted: { change: 0, direction: 0 } } }
        };
        
        const mockChartData = {
            labels: ['Dia 1', 'Dia 2', 'Dia 3', 'Dia 4', 'Dia 5', 'Dia 6', 'Dia 7'],
            views: [500, 650, 480, 720, 900, 600, 650],
            sales: [15, 20, 12, 25, 30, 18, 22]
        };

        const mockProductMetrics = [
            { name: "Jaqueta de Couro Slim Fit", reel: "Reel 1: Estilo Noturno", image_url: "https://placehold.co/40x40/4f46e5/ffffff?text=J", totalViews: 1200, likes: 90, shares: 25, ctr: 9.5, completion: 65, purchasesStarted: 50, salesFinalized: 18, totalValue: 5400.00, averageTicket: 300.00 },
            { name: "Tênis Esportivo Pro Runner", reel: "Reel 2: Treino e Conforto", image_url: "https://placehold.co/40x40/10b981/ffffff?text=T", totalViews: 1500, likes: 110, shares: 30, ctr: 7.0, completion: 75, purchasesStarted: 40, salesFinalized: 10, totalValue: 2800.50, averageTicket: 280.05 },
            { name: "Vestido de Festa Longo (YouTube)", reel: "Reel 3: Dicas de Moda", image_url: "https://placehold.co/40x40/ef4444/ffffff?text=V", totalViews: 800, likes: 60, shares: 15, ctr: 10.5, completion: 50, purchasesStarted: 30, salesFinalized: 12, totalValue: 3500.00, averageTicket: 291.67 },
            { name: "Camisa Casual Algodão", reel: "Reel 4: Look do Dia", image_url: "https://placehold.co/40x40/f97316/ffffff?text=C", totalViews: 1000, likes: 60, shares: 15, ctr: 6.0, completion: 80, purchasesStarted: 30, salesFinalized: 5, totalValue: 800.00, averageTicket: 160.00 },
        ];
        
        // Definição de TODAS as métricas, incluindo o status de destaque (highlight)
        const allMetricsDefinition = [
            // Categoria: Engajamento (DESTAQUE: Total Views)
            { title: "Total Views", key: 'totalViews', format: 'number', size: 'medium', icon: 'eye', category: 'engagement' },
            // REMOVIDO: { title: "Views Até o Fim (%)", key: 'completion', format: 'percentage', size: 'small', icon: 'zap', category: 'engagement' },
            { title: "Total de Likes", key: 'totalLikes', format: 'number', size: 'small', icon: 'heart', category: 'engagement' },
            { title: "Total de Shares", key: 'totalShares', format: 'number', size: 'small', icon: 'share-2', category: 'engagement' },
            
            // Categoria: Conversão (DESTAQUE: Vendas Finalizadas)
            { title: "Vendas Finalizadas", key: 'salesFinalized', format: 'number', size: 'medium', icon: 'check-circle', category: 'conversion' },
            { title: "Taxa de Cliques (CTR)", key: 'totalCTR', format: 'percentage', size: 'small', icon: 'mouse-pointer', category: 'conversion' },
            { title: "Compras Iniciadas", key: 'purchasesStarted', format: 'number', size: 'small', icon: 'shopping-cart', category: 'conversion' },
            
            // Categoria: Financeiro (DESTAQUE: Valor Total Gerado)
            { title: "Valor Total Gerado", key: 'totalValue', format: 'currency', size: 'medium', icon: 'dollar-sign', category: 'financial' },
            { title: "Ticket Médio", key: 'averageTicket', format: 'currency', size: 'small', icon: 'wallet', category: 'financial' },
        ];
        
        // Mapeamento de títulos para as categorias
        const categoryTitles = {
            engagement: "Volume e Engajamento",
            conversion: "Conversão (Vendas)",
            financial: "Métricas Financeiras",
        };


        // ------------------------------------------
        // FUNÇÕES DE RENDERIZAÇÃO E GRÁFICOS
        // ------------------------------------------

        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        const getIcon = (title) => {
            switch (title) {
                case 'Total Views': return 'eye';
                case 'Views Até o Fim (%)': return 'zap';
                case 'Total de Likes': return 'heart';
                case 'Total de Shares': return 'share-2';
                case 'Taxa de Cliques (CTR)': return 'mouse-pointer';
                case 'Compras Iniciadas': return 'shopping-cart';
                case 'Vendas Finalizadas': return 'check-circle';
                case 'Valor Total Gerado': return 'dollar-sign';
                case 'Ticket Médio': return 'wallet';
                default: return 'bar-chart';
            }
        };

        const formatValue = (value, format) => {
             switch (format) {
                case 'currency': return formatCurrency(value);
                case 'percentage': return `${value.toFixed(1)}%`;
                default: return new Intl.NumberFormat('pt-BR').format(value);
            }
        };
        
        let miniChartInstances = [];

        function initializeMiniChart(canvasId, data, isHighlight) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const isDarkMode = htmlElement.classList.contains('dark');
            
            // Cores base para o gráfico
            // Se for destaque, a cor é sempre branca (para o fundo escuro do card)
            const color = isHighlight ? 'white' : (isDarkMode ? '#6366f1' : '#4f46e5'); 
            const backgroundColor = isHighlight ? 'rgba(255, 255, 255, 0.4)' : `rgba(79, 70, 229, ${isDarkMode ? 0.2 : 0.1})`;
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(data.length).fill(''),
                    datasets: [{
                        data: data,
                        borderColor: color,
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        fill: true,
                        backgroundColor: backgroundColor,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    layout: { padding: 0 }
                }
            });
        }
        
        /**
         * Gera o HTML para o indicador de tendência (seta + %).
         */
        const renderTrend = (trend) => {
            if (trend.direction === 0) return '';
            
            const trendIcon = trend.direction === 1 ? 'trending-up' : 'trending-down';
            const trendClass = trend.direction === 1 ? 'trend-up' : 'trend-down';
            const textClass = trendClass;
            
            return `
                <div class="flex items-center space-x-1 ml-3">
                    <i data-lucide="${trendIcon}" class="w-4 h-4 ${textClass}"></i>
                    <span class="text-sm font-bold ${textClass}">${trend.change.toFixed(1)}%</span>
                </div>
            `;
        };
        
        /**
         * Renderiza um único card de métrica.
         * @param {object} metricDef Definição da métrica.
         * @param {number} value Valor da métrica.
         * @param {object} trend Tendência.
         * @param {string} size Tamanho do card ('medium', 'small').
         */
        const renderMetricCard = (metricDef, value, trend, size) => {
            const formattedValue = formatValue(value, metricDef.format);
            const icon = getIcon(metricDef.title);
            const cardId = `miniChart-${metricDef.key}`;
            let miniChartData = [Math.random() * 100, Math.random() * 100, Math.random() * 100, Math.random() * 100, Math.random() * 100, Math.random() * 100, Math.random() * 100];

            // CLASSES DE ESTILO BASEADAS NO TAMANHO
            const isMediumHighlight = size === 'medium';
            const cardClasses = isMediumHighlight
                ? 'medium-highlight-card shadow-lg hover:shadow-xl transition duration-300 w-full'
                : 'bg-secondary-light dark:bg-secondary-dark border border-gray-100 dark:border-gray-700 h-full compact-card hover:shadow-lg'; 

            const iconClasses = isMediumHighlight
                ? 'icon-bg' // Estilo definido no <style> para o highlight
                : 'bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300';
                
            const valueClasses = isMediumHighlight ? 'text-highlight-text' : 'text-gray-900 dark:text-white';
            const titleClasses = isMediumHighlight ? 'text-title' : 'text-gray-500 dark:text-gray-400';

            if (size === 'medium') {
                // Layout Médio (Destaque Categoria - Ocupa 100% da coluna)
                return `
                    <div class="p-5 rounded-xl ${cardClasses} w-full">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium ${titleClasses}">${metricDef.title}</p>
                                <div class="flex items-center mt-1">
                                    <p class="text-2xl font-bold ${valueClasses}">${formattedValue}</p>
                                    ${renderTrend(trend)}
                                </div>
                            </div>
                            <div class="flex-shrink-0 p-2 rounded-full ${iconClasses}">
                                <i data-lucide="${icon}" class="w-5 h-5"></i>
                            </div>
                        </div>
                        <div class="w-full h-12 mt-3">
                            <canvas id="${cardId}" data-chart-data="${miniChartData.join(',')}" data-is-highlight="true"></canvas>
                        </div>
                    </div>
                `;
            } else {
                // Layout Compacto (Small - Dentro da Categoria)
                 return `
                    <div class="p-4 rounded-xl shadow-md transition duration-300 ${cardClasses} w-full">
                        <div class="flex justify-between items-center">
                            <p class="text-xs font-medium ${titleClasses}">${metricDef.title}</p>
                             <div class="flex-shrink-0 p-1 rounded-full ${iconClasses}">
                                <i data-lucide="${icon}" class="w-4 h-4"></i>
                            </div>
                        </div>
                        <div class="flex items-center mt-2">
                            <p class="text-lg font-bold ${valueClasses}">${formattedValue}</p>
                            ${renderTrend(trend)}
                        </div>
                         <div class="w-full h-8 mt-2">
                            <canvas id="${cardId}" data-chart-data="${miniChartData.join(',')}" data-is-highlight="false"></canvas>
                        </div>
                    </div>
                `;
            }
        };

        /**
         * Renderiza as categorias secundárias em 3 colunas.
         */
        const renderAllMetrics = (allMetrics) => {
            const secondaryContainer = document.getElementById('secondaryMetricsContainer');
            
            secondaryContainer.innerHTML = '';
            
            miniChartInstances.forEach(chart => chart.destroy());
            miniChartInstances = [];

            const filterKey = document.getElementById('timeFilter').value;
            const currentPeriodData = allMetrics[filterKey] || allMetrics.last_7_days;
            const trends = currentPeriodData.trends || {};
            
            // Agrupamento de todas as métricas por categoria
            const categorizedMetrics = allMetricsDefinition.reduce((acc, metric) => {
                if (!acc[metric.category]) {
                    acc[metric.category] = { medium: null, small: [] };
                }
                if (metric.size === 'medium') {
                    acc[metric.category].medium = metric;
                } else if (metric.size === 'small') {
                    acc[metric.category].small.push(metric);
                }
                return acc;
            }, {});

            let secondaryHtml = ''; 
            
            // Itera sobre as categorias e renderiza a estrutura hierárquica (Medium + Small)
            for (const categoryKey in categorizedMetrics) {
                const group = categorizedMetrics[categoryKey];
                
                if (!group.medium) continue; 
                
                // Renderiza o card MEDIUM (Destaque da Coluna)
                const mediumMetricDef = group.medium;
                const mediumValue = currentPeriodData[mediumMetricDef.key] !== undefined ? currentPeriodData[mediumMetricDef.key] : 0;
                const mediumTrend = trends[mediumMetricDef.key] || {};
                const mediumCard = renderMetricCard(mediumMetricDef, mediumValue, mediumTrend, 'medium');

                // Renderiza os cards SMALL
                let smallCardsHtml = '';
                group.small.forEach(metricDef => {
                    const value = currentPeriodData[metricDef.key] !== undefined ? currentPeriodData[metricDef.key] : 0;
                    const trend = trends[metricDef.key] || {};
                    smallCardsHtml += renderMetricCard(metricDef, value, trend, 'small');
                });
                
                // Estrutura da Coluna: Título, Card MEDIUM, Cards SMALL (em grid de 2)
                secondaryHtml += `
                    <div class="space-y-4"> 
                        <h3 class="text-xl font-semibold border-b border-gray-200 dark:border-gray-700 pb-2">${categoryTitles[categoryKey] || 'Outras Métricas'}</h3>
                        
                        <div class="flex flex-col gap-4">
                            <!-- Card MEDIUM (Destaque da Categoria) -->
                            ${mediumCard}
                            
                            <!-- Cards SMALL (Agrupados em 2 colunas dentro da coluna da categoria) -->
                            <div class="grid grid-cols-2 gap-4"> 
                                ${smallCardsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }
            secondaryContainer.innerHTML = secondaryHtml;
            
            // Re-renderiza ícones do Lucide
            lucide.createIcons();
            
            // Inicializa os mini-gráficos após o DOM ser atualizado
            document.querySelectorAll('canvas[id^="miniChart-"]').forEach(canvas => {
                const data = canvas.dataset.chartData.split(',').map(Number);
                const isHighlight = canvas.dataset.isHighlight === 'true'; 
                const chart = initializeMiniChart(canvas.id, data, isHighlight);
                miniChartInstances.push(chart);
            });
        };

        /**
         * Renderiza a tabela de métricas por produto com miniatura.
         */
        const renderProductList = (products) => {
            const tbody = document.getElementById('productListBody');
            tbody.innerHTML = '';

            products.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-150';
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 h-10 w-10">
                                <img class="h-10 w-10 rounded-lg object-cover shadow-md" src="${product.image_url}" alt="Foto do Produto">
                            </div>
                            <div class="flex flex-col min-w-0">
                                <span class="font-bold whitespace-nowrap overflow-hidden text-ellipsis">${product.name}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap overflow-hidden text-ellipsis">${product.reel}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${new Intl.NumberFormat('pt-BR').format(product.totalViews)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${new Intl.NumberFormat('pt-BR').format(product.likes)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${new Intl.NumberFormat('pt-BR').format(product.shares)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-600 dark:text-indigo-400 font-semibold">${product.ctr.toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${product.purchasesStarted}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${product.salesFinalized}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white">${formatCurrency(product.totalValue)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${formatCurrency(product.averageTicket)}</td>
                `;
                tbody.appendChild(row);
            });
        };
        
        // ------------------------------------------
        // LÓGICA DO GRÁFICO PRINCIPAL (REMOVIDA)
        // ------------------------------------------


        /**
         * Aplica o filtro selecionado e re-renderiza o Dashboard.
         */
        const applyFilter = (filterKey) => {
            const metrics = mockGlobalMetrics[filterKey] || mockGlobalMetrics.last_7_days;
            const periodLabel = document.getElementById('timeFilter').options[document.getElementById('timeFilter').selectedIndex].text;
            
            document.getElementById('currentPeriod').textContent = `(${periodLabel})`;
            
            // 1. Renderiza todas as métricas (primárias e secundárias) e mini-gráficos
            renderAllMetrics(mockGlobalMetrics); 
            
            // 2. O gráfico principal foi removido, então não há necessidade de inicializá-lo.
            // initializeMainChart(mockChartData);

            // 3. LÓGICA ATUALIZADA: Simulação de exibição/ocultação do filtro customizado
            const customRange = document.getElementById('customDateRange');
            if (filterKey === 'custom') {
                customRange.classList.remove('hidden');
                customRange.classList.add('flex'); // Usa flex para aparecer inline
            } else {
                customRange.classList.add('hidden');
                customRange.classList.remove('flex');
            }
        };
        
        // ------------------------------------------
        // INICIALIZAÇÃO
        // ------------------------------------------

        // Inicializa o Dashboard com o filtro padrão (Últimos 7 dias)
        document.getElementById('timeFilter').value = 'last_7_days';
        applyFilter('last_7_days'); 
        
        // Renderiza a lista de produtos (fixa neste exemplo)
        renderProductList(mockProductMetrics);
        
    </script>
</body>
</html>